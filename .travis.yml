sudo: false
language: perl
perl:
    - "5.20-shrplib"
    - "5.18-shrplib"
    - "system-perl"
env:
    - CC=clang
    - CC=gcc

addons:
    apt:
        packages:
            - libperl-dev
            - elinks

before_install:
    - perl -V
    - version="$(git describe --dirty --long --always --tags | tr -- '-|' '+-')"
    - sed -i -e "s|AC_INIT(irssi,.*|AC_INIT(irssi, $version)|" configure.ac
    - ./autogen.sh --with-proxy --with-bot --with-perl=module
    - make dist
    - cd ..
    - tar xaf */irssi-*.tar.*
    - cd irssi-*
    - cp -a "$TRAVIS_BUILD_DIR"/.git .
    - git checkout -b build/autoconf
    - git add -A .
    - git config user.email 'source@irssi.org'
    - git config user.name 'Irssi Source Helper'
    - git commit -q -m 'autoconf for '"$version $TRAVIS_COMMIT"$'\n\n''[skip ci]'
    - |
      if [ "$TRAVIS_PULL_REQUEST" = false ] && [ "$TRAVIS_BRANCH" = "master" ] && [ "${TRAVIS_JOB_NUMBER##*.}" = 1 ] && $TRAVIS_SECURE_ENV_VARS; then
        git config remote.origin.url git@github.com:$TRAVIS_REPO_SLUG
        echo "$PUSHKEY" > ~/.ssh/id_rsa
        git push -f -u origin build/autoconf
      fi
    - unset PUSHKEY

install:
    - ./configure --with-proxy --with-bot --with-perl=module --prefix=$HOME/irssi-build
    - make CFLAGS="-Wall -Werror"
    - make install

before_script:
    - cd
    - mkdir irssi-test
    - echo echo automated irssi launch test > irssi-test/startup;
      echo ^set settings_autosave off >> irssi-test/startup;
      echo ^set -clear log_close_string >> irssi-test/startup;
      echo ^set -clear log_day_changed >> irssi-test/startup;
      echo ^set -clear log_open_string >> irssi-test/startup;
      echo ^set log_timestamp '* ' >> irssi-test/startup;
      echo ^window log on >> irssi-test/startup
    - echo load perl >> irssi-test/startup
    - echo load proxy >> irssi-test/startup
    - echo ^quit >> irssi-test/startup
    - irssi-build/bin/irssi --home irssi-test
    - cat irc.log.*

script: true
